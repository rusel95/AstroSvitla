import Foundation
import CoreLocation

struct AIPromptBuilder {

    struct Prompt {
        let system: String
        let user: String
    }

    func makePrompt(
        for area: ReportArea,
        birthDetails: BirthDetails,
        natalChart: NatalChart,
        knowledgeSnippets: [String],
        languageCode: String,
        languageDisplayName: String,
        repositoryContext: String,
        includeSourceCitations: Bool = true
    ) -> Prompt {
        let citationRequirement: String
        if includeSourceCitations {
            citationRequirement = """
            CRITICAL REQUIREMENT: ALL facts, interpretations, and statements MUST come from established astrological literature. NO speculation or made-up information.
            - PRIORITIZE the knowledge snippets provided from the vector database (when available)
            - For aspects and house interpretations, be HIGHLY ACCURATE and cite specific sources
            - If vector database knowledge is unavailable, cite classical astrological texts or modern psychological astrology authorities
            - NEVER make general statements without a source citation
            """
        } else {
            citationRequirement = """
            Base your interpretations on established astrological knowledge. Provide professional, accurate analysis without inline source citations.
            """
        }

        let systemMessage = """
        You are a professional astrologer with 20+ years of experience. Always respond with warm, practical, motivating interpretations tailored to the user's natal chart. Avoid daily horoscope clichés.

        \(citationRequirement)

        Always answer in language: \(languageDisplayName) (language code: \(languageCode)).
        Project repository context:
        \(repositoryContext)
        """

        let knowledgeSection: String = {
            guard knowledgeSnippets.isEmpty == false else {
                return "Релевантні уривки з бази знань не знайдені для цієї теми."
            }
            let formatted = knowledgeSnippets.prefix(6).enumerated().map { index, snippet in
                "\(index + 1). \(snippet)"
            }.joined(separator: "\n")
            return "НАЙДЕАКТИВНІШІ ПРАВИЛА З ВЕКТОРНОЇ БАЗИ ЗНАНЬ:\n\(formatted)"
        }()

        let vectorInstruction: String
        if knowledgeSnippets.isEmpty {
            vectorInstruction = includeSourceCitations
                ? """
                Vector knowledge snippets were NOT provided. Set knowledge_usage.vector_source_used to false and explain why in notes.
                IMPORTANT: Still cite classical astrological authorities for ALL interpretations. Never speculate.
                """
                : "Vector knowledge snippets were NOT provided. Set knowledge_usage.vector_source_used to false."
        } else {
            vectorInstruction = includeSourceCitations
                ? """
                Vector knowledge snippets WERE provided. Use them as PRIMARY sources for your interpretations.
                CRITICAL: For aspect and house interpretations, base your analysis STRICTLY on the provided knowledge snippets.
                Set knowledge_usage.vector_source_used to true and cite specific snippets with chunk IDs in the sources array.
                """
                : "Vector knowledge snippets WERE provided. Use them for your interpretations. Set knowledge_usage.vector_source_used to true."
        }

        // Dynamic key_influences instruction based on citation mode
        let keyInfluencesInstruction = includeSourceCitations
            ? "\"key_influences\": [\"10 марковані пунктів з ключовими впливами (ОБОВ'ЯЗКОВО для всіх планет: Сонце, Місяць, Меркурій, Венера, Марс, Юпітер, Сатурн, Уран, Нептун, Плутон). Кожен пункт має містити посилання на джерело в квадратних дужках, наприклад: '...це вказує на креативність [Роберт Хенд, Планети в транзиту, стор. 45-48]'\"],"
            : "\"key_influences\": [\"10 марковані пунктів з ключовими впливами (ОБОВ'ЯЗКОВО для всіх планет: Сонце, Місяць, Меркурій, Венера, Марс, Юпітер, Сатурн, Уран, Нептун, Плутон)\"],"

        // Dynamic detailed_analysis instruction based on citation mode
        let detailedAnalysisInstruction: String
        if includeSourceCitations {
            detailedAnalysisInstruction = """
            "detailed_analysis": "Розгорнутий аналіз 6-8 абзаців українською, який ОБОВ'ЯЗКОВО містить:\\n1. Пояснення Асцендента (знак і значення для особистості та підходу до життя)\\n2. Пояснення Середини Неба/MC (знак і значення для кар'єри, репутації та життєвого напрямку)\\n3. Роз'яснення про розташування кармічних вузлів (Північний вузол - куди йти, Південний вузол - що залишити позаду), їх дома та осі домів\\n4. Роз'яснення про існуючі аспекти між кармічними вузлами та іншими планетами\\n5. Роз'яснення про розміщення і значення Ліліт/Чорної Місяць (знак, дім, тіньові теми)\\n6. Аналіз управителів домів (особливо Асцендента, 7-го та 10-го домів): де вони знаходяться і що це означає\\n7. Детальний аналіз мінімум 20 найтісніших аспектів між планетами (з посиланням на конкретні кути та орби)\\n\\nВАЖЛИВО: Після КОЖНОГО твердження, висновку або інтерпретації додавай inline-посилання на джерело в квадратних дужках, наприклад:\\n- 'Венера у Тільці створює сильну потребу у стабільності [Ліз Грін, Астрологія долі, стор. 123-126]'\\n- 'Тригон Місяця до Юпітера дарує оптимізм [Стівен Арройо, Астрологія, психологія і чотири стихії, Розділ 5]'\\n- 'Сатурн у 10-му домі вказує на кар'єрні амбіції [Говард Саспортас, Боги змін, стор. 89-92]'\\nЯкщо використовуєш інформацію НЕ з бази даних, а з загальних астрологічних знань, вкажи [Класична астрологія] або [Сучасна психологічна астрологія].",
            """
        } else {
            detailedAnalysisInstruction = """
            "detailed_analysis": "Розгорнутий аналіз 6-8 абзаців українською, який ОБОВ'ЯЗКОВО містить:\\n1. Пояснення Асцендента (знак і значення для особистості та підходу до життя)\\n2. Пояснення Середини Неба/MC (знак і значення для кар'єри, репутації та життєвого напрямку)\\n3. Роз'яснення про розташування кармічних вузлів (Північний вузол - куди йти, Південний вузол - що залишити позаду), їх дома та осі домів\\n4. Роз'яснення про існуючі аспекти між кармічними вузлами та іншими планетами\\n5. Роз'яснення про розміщення і значення Ліліт/Чорної Місяць (знак, дім, тіньові теми)\\n6. Аналіз управителів домів (особливо Асцендента, 7-го та 10-го домів): де вони знаходяться і що це означає\\n7. Детальний аналіз мінімум 20 найтісніших аспектів між планетами (з посиланням на конкретні кути та орби)",
            """
        }

        // Dynamic recommendations instruction based on citation mode
        let recommendationsInstruction = includeSourceCitations
            ? "\"recommendations\": [\"3-4 практичні поради українською, починай з дієслова. Кожна порада також має містити посилання на джерело в квадратних дужках.\"],"
            : "\"recommendations\": [\"3-4 практичні поради українською, починай з дієслова.\"],"

        // Dynamic knowledge usage section
        let knowledgeUsageSection: String
        if includeSourceCitations {
            knowledgeUsageSection = """
            "knowledge_usage": {
                "vector_source_used": true або false,
                "notes": "Коротке пояснення українською",
                "sources": [
                  {
                    "book_title": "Назва книги/джерела з векторної бази",
                    "author": "Автор книги (якщо відомо)",
                    "section": "Розділ/секція (якщо відомо)",
                    "page_range": "Сторінки (якщо відомо)",
                    "snippet": "Короткий уривок/цитата з джерела, що була використана",
                    "relevance_score": 0.95,
                    "chunk_id": "унікальний ID чанку з бази"
                  }
                ],
                "available_books": [
                  {
                    "book_title": "Назва книги в базі даних",
                    "author": "Автор книги",
                    "total_chunks": 42,
                    "used_chunks": ["chunk_id_1", "chunk_id_5"],
                    "available_chunks": [
                      {
                        "chunk_id": "chunk_id_1",
                        "section": "Розділ 3: Аспекти",
                        "page_range": "стор. 45-48",
                        "preview": "Перші 100 символів тексту чанку...",
                        "full_text": "ПОВНИЙ текст цього чанку з векторної бази. Включи весь текст чанку, який є в базі даних.",
                        "was_used": true
                      },
                      {
                        "chunk_id": "chunk_id_2",
                        "section": "Розділ 4: Планети",
                        "page_range": "стор. 52-55",
                        "preview": "Інші 100 символів тексту чанку...",
                        "full_text": "ПОВНИЙ текст іншого чанку з векторної бази. Включи весь текст чанку, який є в базі даних.",
                        "was_used": false
                      }
                    ]
                  }
                ]
              }
            """
        } else {
            knowledgeUsageSection = """
            "knowledge_usage": {
                "vector_source_used": true або false,
                "notes": "Коротке пояснення українською"
              }
            """
        }

        // Dynamic sources instructions
        let sourcesInstructions: String
        if includeSourceCitations {
            sourcesInstructions = """

            ВАЖЛИВО ПРО ДЖЕРЕЛА:
            1. Якщо ти використовуєш знання з векторної бази, обов'язково заповни масив "sources" з конкретними джерелами, які ти використав. Вкажи назву книги, автора, розділ, chunk_id і короткий уривок тексту.
            2. ОБОВ'ЯЗКОВО заповни масив "available_books" з ПОВНИМ списком усіх книг у твоїй векторній базі знань з астрології. Для кожної книги вкажи:
               - Назву книги та автора
               - Загальну кількість чанків (total_chunks)
               - Список ID чанків, які ти використав для цієї відповіді (used_chunks)
               - Список усіх доступних чанків з цієї книги (available_chunks) - мінімум 5-10 варіантів на книгу, включаючи:
                 * chunk_id - унікальний ідентифікатор
                 * section - назва розділу/теми
                 * page_range - сторінки
                 * preview - перші 80-120 символів тексту чанку
                 * full_text - ПОВНИЙ текст чанку з векторної бази (весь текст, без скорочень)
                 * was_used - чи був використаний цей чанк в аналізі (true/false)
            3. Це дозволить користувачу побачити ВСЮ доступну базу знань і які саме фрагменти були використані для генерації його звіту.
            """
        } else {
            sourcesInstructions = ""
        }

        // Dynamic accuracy requirements
        let accuracyRequirements: String
        if includeSourceCitations {
            accuracyRequirements = """
            КРИТИЧНО ВАЖЛИВІ ВИМОГИ ЩОДО ТОЧНОСТІ:
            • НЕ ДОДУМУЙ факти. Кожне твердження має базуватися на літературі з астрології.
            • ПРІОРИТЕТ: використовуй надану векторну базу знань (якщо доступна).
            • Аналіз АСПЕКТІВ і ДОМІВ має бути максимально точним і ґрунтуватися на конкретних джерелах.
            • Якщо надана база знань НЕ містить інформації про конкретний аспект або дім - цитуй класичні астрологічні тексти (Ліз Грін, Роберт Хенд, Стівен Арройо, Говард Саспортас, тощо).
            • ЗАВЖДИ вказуй джерело після кожного речення/абзацу в квадратних дужках [Автор, Книга, сторінки].
            """
        } else {
            accuracyRequirements = """
            ВИМОГИ ЩОДО ТОЧНОСТІ:
            • Базуйся на встановлених астрологічних знаннях.
            • Аналіз АСПЕКТІВ і ДОМІВ має бути максимально точним та професійним.
            • НЕ додавай посилання на джерела у тексті відповіді.
            """
        }

        let userMessage = """
        СФОРМУЙ ВІДПОВІДЬ У ФОРМАТІ JSON БЕЗ ЖОДНОГО ДОДАТКОВОГО ТЕКСТУ. Використай наступну структуру:

        {
          "summary": "1-2 речення короткого підсумку українською.",
          \(keyInfluencesInstruction)
          \(detailedAnalysisInstruction)
          \(recommendationsInstruction)
          \(knowledgeUsageSection)
        }
        \(sourcesInstructions)
        Вихідні дані:
        • Ім'я/позначення: \(birthDetails.displayName)
        • Дата народження: \(birthDetails.formattedBirthDate)
        • Час народження: \(birthDetails.formattedBirthTime)
        • Локація: \(birthDetails.formattedLocation)
        • Координати: \(coordinateString(from: birthDetails))
        • Часовий пояс: \(birthDetails.timeZone.identifier)

        Життєва сфера для інтерпретації: \(area.displayName) — напиши аналіз саме для цієї сфери.

        Додатковий фокус для цієї сфери:
        \(focus(for: area))

        Контекст для натальної карти (реальні розрахунки, використовуй для точного аналізу):
        \(formatNatalChartData(natalChart))

        \(knowledgeSection)

        \(vectorInstruction)

        \(accuracyRequirements)

        Вимоги:
        • Поверни відповідь мовою \(languageDisplayName) (код \(languageCode)).
        • Поверни лише валідний JSON без додаткових пояснень.
        • Тримайся заданої структури та довжини.
        • Підлаштуй змісти пунктів під сферу \(area.displayName.lowercased()).
        """

        return Prompt(system: systemMessage, user: userMessage)
    }

    private func coordinateString(from details: BirthDetails) -> String {
        guard let coordinate = details.coordinate else {
            return "невідомі"
        }
        let formattedLatitude = format(coordinate.latitude, positiveSuffix: "N", negativeSuffix: "S")
        let formattedLongitude = format(coordinate.longitude, positiveSuffix: "E", negativeSuffix: "W")
        return "\(formattedLatitude), \(formattedLongitude)"
    }

    private func format(_ value: Double, positiveSuffix: String, negativeSuffix: String) -> String {
        let suffix = value >= 0 ? positiveSuffix : negativeSuffix
        let absolute = abs(value)
        return String(format: "%.2f°%@", absolute, suffix)
    }

    private func formatNatalChartData(_ chart: NatalChart) -> String {
        var lines: [String] = []

        // Ascendant and Midheaven
        let ascSign = ZodiacSign.from(degree: chart.ascendant)
        let mcSign = ZodiacSign.from(degree: chart.midheaven)
        lines.append("Асцендент (ASC): \(format(degree: chart.ascendant)) у \(ascSign.rawValue)")
        lines.append("Середина неба (MC): \(format(degree: chart.midheaven)) у \(mcSign.rawValue)")

        // Planets
        lines.append("\nПланети:")
        for planet in chart.planets {
            let retro = planet.isRetrograde ? " (ретроградна)" : ""
            lines.append("- \(planet.name.rawValue): \(format(degree: planet.longitude)) у \(planet.sign.rawValue), \(planet.house) дім\(retro)")
        }

        // Houses
        lines.append("\nДоми (куспіди):")
        for house in chart.houses.sorted(by: { $0.number < $1.number }) {
            lines.append("- Дім \(house.number): \(format(degree: house.cusp)) у \(house.sign.rawValue)")
        }

        // House Rulers (key ones)
        if !chart.houseRulers.isEmpty {
            lines.append("\nУправителі домів (ключові):")
            // Show Ascendant ruler (1st house), 7th house (relationships), 10th house (career)
            for houseNum in [1, 7, 10] {
                if let ruler = chart.houseRulers.first(where: { $0.houseNumber == houseNum }) {
                    lines.append("- Дім \(houseNum) управляється \(ruler.rulingPlanet.rawValue) (у \(ruler.rulerSign.rawValue), дім \(ruler.rulerHouse))")
                }
            }
        }

        // Major Aspects (expanded to 20)
        if !chart.aspects.isEmpty {
            lines.append("\nОсновні аспекти (20 найтісніших, відсортовано за орбом):")
            for (index, aspect) in chart.aspects.prefix(20).enumerated() {
                lines.append("- \(index + 1). \(aspect.planet1.rawValue) \(aspect.type.rawValue) \(aspect.planet2.rawValue) (орб: \(String(format: "%.2f", aspect.orb))°)")
            }
        }

        return lines.joined(separator: "\n")
    }

    private func format(degree: Double) -> String {
        let normalized = degree.truncatingRemainder(dividingBy: 360)
        let degrees = Int(normalized)
        let minutes = Int((normalized - Double(degrees)) * 60)
        return "\(degrees)°\(minutes)'"
    }

    private func focus(for area: ReportArea) -> String {
        switch area {
        case .finances:
            return """
            ФІНАНСОВИЙ АНАЛІЗ - Розгорнута астрологічна перспектива на матеріальний добробут та ресурси:

            ОСНОВНІ ПОКАЗНИКИ:
            • 2-й дім (особисті фінанси): детально проаналізуй знак на куспіді, планети у домі, управителя дому (де знаходиться, в якому знаку/домі, які аспекти формує). Поясни природжені таланти заробітку та ставлення до грошей.
            • 8-й дім (спільні ресурси, інвестиції, спадщина): розглянь знак на куспіді, планети в домі, управителя. Опиши потенціал пасивного доходу, інвестицій, фінансових партнерств та трансформації через ресурси.
            • 11-й дім (доходи від кар'єри та соціальних зв'язків): проаналізуй можливості заробітку через мережу, колективні проєкти та довгострокові фінансові цілі.

            ПЛАНЕТАРНІ ВПЛИВИ:
            • Венера (природний сигніфікатор цінностей та матеріального комфорту): її знак, дім, аспекти, диспозитор. Опиши фінансові цінності та стиль витрачання.
            • Юпітер (розширення, удача, зростання): його розташування та аспекти до осі 2-8 домів. Де і як приходить фінансова експансія?
            • Сатурн (структура, обмеження, довгострокове планування): його вплив на фінансову дисципліну, затримки або ретельне накопичення.
            • Плутон (трансформація, великі гроші, влада через ресурси): його зв'язок з 2-м та 8-м домами показує потенціал радикальних фінансових змін.

            КРИТИЧНІ АСПЕКТИ:
            • Аспекти між управителями 2-го, 8-го та 11-го домів - показують інтеграцію різних джерел доходу.
            • Аспекти Венери-Юпітера (оптимізм vs надмірні витрати).
            • Аспекти Венери-Сатурна (економія vs обмеження).
            • Аспекти до Північного Вузла від фінансових планет - кармічний шлях до матеріального успіху.

            ПСИХОЛОГІЧНИЙ КОНТЕКСТ:
            • Глибинні переконання про гроші (чи достатньо ресурсів у світі? заслуговую я на багатство?).
            • Зв'язок між самооцінкою (2-й дім) та фінансовим станом.
            • Спадкові фінансові патерни (4-й дім, Місяць, Сатурн).
            • Баланс між накопиченням (Тілець/2-й дім) та трансформацією через ресурси (Скорпіон/8-й дім).

            ПРАКТИЧНІ РЕКОМЕНДАЦІЇ:
            • Найбільш природні та ефективні способи заробітку згідно з картою.
            • Ризики (імпульсивні витрати, надмірна обережність, залежність від інших).
            • Оптимальні стратегії інвестування та управління ресурсами.
            • Як використати сильні сторони для фінансового зростання.
            """

        case .career:
            return """
            КАР'ЄРНИЙ АНАЛІЗ - Професійне покликання, репутація та життєвий напрямок:

            ОСНОВНІ ПОКАЗНИКИ:
            • Середина Неба (MC/10-й дім): найважливіший показник публічного іміджу, кар'єрних амбіцій та соціального статусу. Детально опиши знак на MC, планети у 10-му домі, управителя MC (де він, які аспекти формує). Яка професійна роль найбільш природна?
            • 6-й дім (щоденна робота, служіння, навички): знак на куспіді, планети в домі, управитель. Опиши ставлення до роботи, трудову етику, майстерність у конкретних навичках.
            • 2-й дім (заробіток) та 11-й дім (довгострокові цілі, соціальна мережа): як вони підтримують кар'єру?

            ПЛАНЕТАРНІ ВПЛИВИ:
            • Сонце (життєва ціль, ідентичність через діяльність): його знак, дім, аспекти. Де людина сяє професійно?
            • Сатурн (амбіції, структура, авторитет, довгострокова відповідальність): особливо важливий для кар'єри. Його позиція показує сферу, де людина може стати майстром або експертом.
            • Марс (дія, ініціатива, конкуренція, драйв): його сила та аспекти показують енергію для досягнення цілей та стиль лідерства.
            • Юпітер (зростання, визнання, розширення можливостей): де приходить професійний успіх та громадське визнання?
            • Управитель Асцендента (самопрезентація у світі): де він знаходиться? Якщо у 10-му або 6-му домі - кар'єра центральна у життєвому шляху.

            КРИТИЧНІ АСПЕКТИ:
            • Аспекти до MC та його управителя - формують характер професійної долі.
            • Сонце-Сатурн (дисципліна, амбіції vs тиск, самообмеження).
            • Марс-Сатурн (структурована дія vs фрустрація, блокування енергії).
            • Сонце-Юпітер або MC-Юпітер (природжена здатність до зростання та успіху).
            • Зв'язки між управителями 10-го, 6-го, 2-го домів - інтеграція покликання, роботи та доходу.

            ДОДАТКОВІ ФАКТОРИ:
            • Північний Вузол у 10-му домі або у аспекті до MC - кар'єра є кармічним призначенням.
            • Південний Вузол у 10-му або 6-му - минулий досвід, який потрібно переосмислити.
            • Частина Фортуни у зв'язку з MC - де прийде найбільше задоволення та успіх.
            • Хірон у 10-му або 6-му - рана, яка стає даром у професії (вчитель через власний біль).

            ПСИХОЛОГІЧНИЙ КОНТЕКСТ:
            • Внутрішнє покликання vs зовнішні очікування (сім'ї, суспільства).
            • Автентичність у кар'єрі: чи відображає робота справжню сутність людини?
            • Баланс між амбіціями (10-й дім) та служінням (6-й дім).
            • Інтеграція чоловічої (Сонце, Марс, Сатурн) та жіночої (Місяць, Венера) енергій у професії.

            ПРАКТИЧНІ РЕКОМЕНДАЦІЇ:
            • Найбільш підходящі професійні сфери та ролі згідно з архетипами карти.
            • Стиль лідерства та взаємодії з колегами/підлеглими.
            • Потенційні виклики (вигорання, конфлікт цінностей, надмірні амбіції).
            • Як інтегрувати таланти (Юпітер, Венера, природні дари) у кар'єру для максимальної самореалізації.
            """

        case .relationships:
            return """
            АНАЛІЗ СТОСУНКІВ - Любов, партнерство, близькість та міжособистісна динаміка:

            ОСНОВНІ ПОКАЗНИКИ:
            • 7-й дім (партнерство, шлюб, відкриті відносини): найголовніший для розуміння партнерської динаміки. Детально опиши знак на Десценденті (куспід 7-го дому), планети у 7-му домі, управителя 7-го дому (де він, аспекти, стан). Який тип партнера приваблює? Які уроки через стосунки?
            • 5-й дім (романтика, флірт, творча самовираження через кохання): знак на куспіді, планети, управитель. Опиши стиль закоханості, романтичні потреби, спонтанність у любові.
            • 8-й дім (глибока емоційна та сексуальна близькість, трансформація через іншого): показує здатність до інтимності, довіри, спільних ресурсів та душевного злиття.
            • 4-й дім та Місяць (емоційна безпека, родинні патерни): як спадкові моделі стосунків впливають на вибір партнера та стиль прив'язаності.

            ПЛАНЕТАРНІ ВПЛИВИ:
            • Венера (природний сигніфікатор любові, краси, гармонії, цінностей у стосунках): її знак, дім, аспекти, диспозитор. Що приносить задоволення у партнерстві? Як людина дарує та отримує любов?
            • Марс (сексуальність, пристрасть, асертивність, бажання): його позиція та аспекти показують еротичну природу, стиль залицяння, здатність виражати потреби.
            • Місяць (емоційні потреби, внутрішня дитина, потреба у догляді): його знак, дім, аспекти до Венери/Марса - показують емоційну сумісність та глибинні потреби у близькості.
            • Сонце (самоідентичність у стосунках): чи втрачається "я" у партнерстві, чи зростає?
            • Юнона (астероїд довгострокового партнерства та вірності): додатковий фактор для розуміння ідеалу подружжя.

            КРИТИЧНІ АСПЕКТИ:
            • Венера-Марс (інтеграція жіночої та чоловічої енергій, сексуальна хімія vs конфлікт бажань).
            • Венера-Сатурн (серйозність, відданість vs страх близькості, емоційна холодність).
            • Венера-Уран (потреба у свободі vs зобов'язання, нетрадиційні стосунки).
            • Венера-Нептун (романтична ідеалізація vs розчарування, духовна любов).
            • Місяць-Венера (гармонія емоцій та почуттів) або Місяць-Марс (емоційна пристрасність vs реактивність).
            • Аспекти управителя 7-го дому до інших планет - показують динаміку з партнером.

            ВУЗЛИ ДОЛІ ТА КАРМІЧНИЙ КОНТЕКСТ:
            • Північний Вузол у 7-му домі або у Терезах - урок цього життя: навчитися справжньому партнерству.
            • Південний Вузол у 7-му або 1-му - минулі патерни (залежність vs відокремленість), які потрібно переробити.
            • Хірон у 7-му, 5-му або 8-му - рана у стосунках, яка веде до зцілення (своєї та інших).

            ПСИХОЛОГІЧНИЙ КОНТЕКСТ:
            • Стиль прив'язаності (тривожний, уникаючий, безпечний) згідно з аспектами Місяця та Венери.
            • Проєкції: які якості (7-й дім, Десцендент) людина шукає у партнері, а не розвиває у собі?
            • Баланс між злиттям (8-й дім, Скорпіон) та автономією (Овен, Марс).
            • Вплив батьківських фігур (Сонце-батько, Місяць-мати) на вибір партнера.
            • Тіньові теми через Ліліт: де у стосунках виникають табу, відкидання, дика жіноча сила?

            ПРАКТИЧНІ РЕКОМЕНДАЦІЇ:
            • Найбільш підходящий тип партнера та стиль стосунків (традиційні vs відкриті, близькі vs незалежні).
            • Потенційні пастки (ідеалізація, втрата меж, конфлікт потреб, страх зобов'язань).
            • Як задовольнити справжні емоційні та романтичні потреби.
            • Шляхи до глибокої інтимності та автентичного партнерства через розуміння власної карти.
            """

        case .health:
            return """
            АНАЛІЗ ЗДОРОВ'я - Фізичне, емоційне та енергетичне благополуччя:

            ОСНОВНІ ПОКАЗНИКИ:
            • 6-й дім (щоденне здоров'я, звички, режим, хвороби): детально опиши знак на куспіді, планети у домі, управителя 6-го дому. Які органи/системи потребують уваги? Які здорові звички підтримують або руйнують тіло?
            • 1-й дім та Асцендент (фізична конституція, життєва сила, зовнішній вигляд): знак Асцендента показує тип тіла та загальну витривалість. Планети у 1-му впливають на фізичне "я".
            • 12-й дім (приховані хвороби, психосоматика, підсвідомі патерни): планети тут можуть вказувати на витіснені емоції, які стають фізичними симптомами, а також потребу в ізоляції для відновлення.
            • 8-й дім (глибокі кризи, регенерація, трансформація через хворобу): хронічні стани або радикальні зцілення.

            ПЛАНЕТАРНІ ВПЛИВИ:
            • Сонце (життєва сила, серцево-судинна система, імунітет, чоловіча енергія): його знак, дім, аспекти показують джерело енергії та загальну витривалість. Слабке Сонце (важкі аспекти до Сатурна/Нептуна) може означати низьку життєву силу.
            • Місяць (емоційне здоров'я, травна система, жіноча репродуктивна система, сон, харчування): його стан показує, наскільки добре людина піклується про себе та відновлюється емоційно.
            • Марс (фізична енергія, м'язи, запалення, тонус, імунна відповідь): сильний Марс дає драйв, слабкий або ураж��ний - втому, запалення або нещасні випадки.
            • Меркурій (нервова система, дихання, руки, комунікація): аспекти до Меркурія показують стрес, тривожність або розумову ясність.
            • Венера (нирки, гормональний баланс, насолода, тілесний комфорт): гармонія Венери = фізична врода та баланс.
            • Сатурн (кістки, зуби, шкіра, хронічні стани, старіння): важкі аспекти Сатурна можуть вказувати на блокування енергії, артрити або депресію.
            • Уран (нервова система, раптові травми або прориви у зціленні).
            • Нептун (імунна система, отруєння, чутливість до ліків/алкоголю, психосоматика).
            • Плутон (глибока регенерація, генетичні фактори, виживання, сексуальна енергія як джерело здоров'я).

            КРИТИЧНІ АСПЕКТИ:
            • Сонце-Сатурн (низька енергія, депресія, потреба у дисципліні для здоров'я).
            • Місяць-Сатурн (емоційна холодність, меланхолія, потреба у структурованій емоційній підтримці).
            • Марс-Сатурн (заблокована енергія, фрустрація, потреба у регулярній фізичній активності).
            • Марс-Уран (раптові травми, нещасні випадки, потреба у безпечному виході адреналіну).
            • Місяць-Нептун (висока емоційна чутливість, схильність до втечі через харчування/алкоголь).
            • Аспекти до управителя 6-го дому - показують, як здоров'я інтегроване у життя.

            ЗНАКИ ТА СХИЛЬНОСТІ:
            • Вогняні знаки (Овен, Лев, Стрілець): висока енергія, але ризик вигорання, запалення, серцево-судинні проблеми.
            • Земні знаки (Тілець, Діва, Козеріг): міцна конституція, але схильність до повільного метаболізму, проблем з кістками/суглобами (Козеріг), горлом (Тілець), кишечником (Діва).
            • Повітряні знаки (Близнюки, Терези, Водолій): нервова система, тривожність, легені (Близнюки), нирки (Терези).
            • Водні знаки (Рак, Скорпіон, Риби): емоційна чутливість, психосоматика, травна система (Рак), репродуктивна/виділення (Скорпіон), лімфатична/імунна (Риби).

            ПСИХОСОМАТИЧНИЙ КОНТЕКСТ:
            • Зв'язок між емоціями (Місяць, 12-й дім) та фізичними симптомами.
            • Вплив хронічного стресу (Сатурн, важкі аспекти) на тіло.
            • Тіло як дзеркало душі: які невиражені потреби стають хворобою?
            • Хірон у 6-му або 12-му - рана через здоров'я, яка веде до холістичного зцілення або допомоги іншим.

            ПРАКТИЧНІ РЕКОМЕНДАЦІЇ:
            • Оптимальний режим дня та харчування згідно з елементами карти (більше вогню - активність, більше води - відпочинок).
            • Фізична активність, яка найбільше підходить (Марс у вогні - інтенсивні тренування, у воді - йога/плавання).
            • Профілактика слабких зон (вразливі органи/системи за знаками та аспектами).
            • Емоційна гігієна: техніки управління стресом та відновлення енергії (медитація для Нептуна, заземлення для Урана, творчість для Венери).
            • Додаткові практики: астрологія медична, аюрведа, траволікування відповідно до знаків та планет.
            """

        case .general:
            return """
            ЗАГАЛЬНИЙ ПОРТРЕТ ОСОБИСТОСТІ - Цілісна картина життєвого шляху, архетипів та призначення:

            ЯДРО ОСОБИСТОСТІ (ТРІЙЦЯ):
            • Сонце (свідома ідентичність, життєва ціль, шлях героя): його знак, дім, аспекти. Де та як людина сяє? Яке її справжнє призначення?
            • Місяць (емоційна натура, потреби, внутрішня дитина, несвідомі реакції): його знак, дім, фаза (зростаючий/спадний місяць при народженні). Що дарує емоційну безпеку? Як людина відновлюється?
            • Асцендент (маска, самопрезентація, фізичне тіло, підхід до життя): знак та управитель Асцендента - це "об'єктив", через який людина дивиться на світ і через який світ бачить її.

            СТРУКТУРА ОСОБИСТОСТІ (АРХЕТИПИ):
            • Меркурій (розум, комунікація, навчання, сприйняття інформації): стиль мислення та обміну ідеями.
            • Венера (цінності, любов, краса, насолода, гроші): що приносить задоволення та як людина формує стосунки.
            • Марс (дія, бажання, гнів, сексуальність, воля): стиль дії та подолання перешкод.
            • Юпітер (віра, зростання, мудрість, удача, ентузіазм): де людина розширюється та знаходить сенс.
            • Сатурн (структура, відповідальність, обмеження, зрілість, майстерність): де виклики, уроки та потенціал стати експертом.
            • Зовнішні планети (Уран, Нептун, Плутон): колективні/трансперсональні теми, покоління, глибинні трансформації.

            ЖИТТЄВІ СФЕРИ (КЛЮЧОВІ ДОМИ):
            • 1-й дім (особистість, самопрезентація, фізичне тіло): знак, планети, управитель.
            • 4-й дім (корені, родина, емоційний фундамент, дім як простір): внутрішня безпека та зв'язок з предками.
            • 7-й дім (партнерство, відображення, інший як дзеркало): яку частину себе людина проєктує на партнера?
            • 10-й дім та MC (призначення, кар'єра, публічна роль, репутація): де людина залишає слід у світі.
            • Вісь 4-10 (приватне vs публічне життя): баланс між внутрішньім та зовнішнім.
            • Вісь 1-7 (я vs інший): баланс між автономією та партнерством.

            КАРМІЧНИЙ ШЛЯХ (ВУЗЛИ ДОЛІ):
            • Північний Вузол (мета цього життя, що розвивати, напрямок еволюції): його знак, дім, аспекти до планет. Який новий досвід необхідний для зростання душі?
            • Південний Вузол (минулий досвід, таланти, звички, від чого відпускати): що вже освоєно у минулих життях, але більше не служить?
            • Вісь вузлів (наприклад, Північний Вузол у Тельці/2-й дім vs Південний у Скорпіоні/8-й дім): інтеграція протилежностей.
            • Планети у з'єднанні з вузлами: особливо важливі теми цього втілення.

            ТІНЬОВІ ТЕМИ ТА ТРАНСФОРМАЦІЯ:
            • Ліліт/Чорна Місяць (відкинута жіноча сила, табу, дикість): де людина відчуває стид, заборону або радикальну автентичність.
            • Хірон (первинна рана, дар через біль): де вразливість стає джерелом зцілення себе та інших.
            • Плутон (глибока трансформація, смерть та відродження, влада): де відбуваються радикальні зміни та виявлення внутрішньої сили.
            • 8-й та 12-й доми (глибини несвідомого, таємниці, приховане): де потрібно зануритися для справжнього переродження.

            ЖИТТЄВІ ЦИКЛИ ТА ФАЗИ:
            • Фаза Місяця при народженні (новий місяць - початківець, повний місяць - завершувач): як людина проживає цикли?
            • Фази Сатурна (повернення у ~29, ~58 років - важливі точки дорослішання).
            • Прогресивний Місяць (змінює знак кожні ~2.5 роки - емоційні фази життя).
            • Транзити зовнішніх планет - покоління та особисті виклики.

            ЕЛЕМЕНТИ ТА МОДАЛЬНОСТІ:
            • Баланс елементів (Вогонь, Земля, Повітря, Вода): яка стихія домінує, якої бракує? Як це впливає на темперамент та потреби?
            • Баланс модальностей (Кардинальні, Фіксовані, Мутабельні): як людина ініціює, підтримує та адаптується?
            • Домінуючий елемент або планета: який архетип найсильніший?

            ІНТЕГРАЦІЯ ТА ЦІЛЬ��СНІСТЬ:
            • Як всі частини карти працюють разом? Які внутрішні конфлікти (напружені аспекти) потребують примирення?
            • Які дари та таланти (гармонійні аспекти, сильні планети) доступні?
            • Шлях індивідуації (за К.Г. Юнгом): інтеграція тіні, анімуса/аніми, Self.
            • Якою може бути найвища версія цієї карти? Як реалізувати повний потенціал?

            ПРАКТИЧНІ РЕКОМЕНДАЦІЇ ДЛЯ ЖИТТЄВОГО ШЛЯХУ:
            • Ключові життєві теми та виклики.
            • Найбільш автентичний спосіб самовираження.
            • Як поєднати різні грані особистості (наприклад, Сонце у Риби vs Асцендент у Скорпіоні).
            • Інструменти для подолання внутрішніх конфліктів та реалізації призначення.
            """
        }
    }
}
