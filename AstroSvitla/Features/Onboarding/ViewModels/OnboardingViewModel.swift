import Foundation
import Combine

@MainActor
final class OnboardingViewModel: ObservableObject {

    @Published private(set) var pages: [OnboardingPage]
    @Published var currentIndex: Int = 0
    @Published private(set) var isCompleted: Bool

    private let storage: UserDefaults
    private static let completionKey = "com.astrosvitla.onboarding.completed"

    init(storage: UserDefaults = .standard) {
        self.storage = storage
        self.pages = OnboardingViewModel.makePages()
        self.isCompleted = storage.bool(forKey: Self.completionKey)
    }

    func advance() -> Bool {
        guard currentIndex < pages.count - 1 else {
            completeOnboarding()
            return true
        }

        currentIndex += 1
        return false
    }

    func goBack() {
        guard currentIndex > 0 else { return }
        currentIndex -= 1
    }

    func skip() -> Bool {
        completeOnboarding()
        return true
    }

    func resetForTesting() {
        isCompleted = false
        currentIndex = 0
        storage.removeObject(forKey: Self.completionKey)
    }

    private func completeOnboarding() {
        guard isCompleted == false else { return }
        isCompleted = true
        storage.set(true, forKey: Self.completionKey)
    }

    private static func makePages() -> [OnboardingPage] {
        [
            // Page 1: Welcome
            OnboardingPage(
                title: "–ü—Ä–∏–≤—ñ—Ç —É —Å–≤—ñ—Ç –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó",
                message: "AstroSvitla –æ–±'—î–¥–Ω—É—î –¥–∞–≤–Ω—ñ –∑–Ω–∞–Ω–Ω—è –∑ —Å—É—á–∞—Å–Ω–æ—é —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—î—é, —â–æ–± –¥–æ–ø–æ–º–æ–≥—Ç–∏ –≤–∞–º —Ä–æ–∑—É–º—ñ—Ç–∏—Å—è –Ω–∞ —Å–æ–±—ñ —Ç–∞ —Å–≤–æ—î–º—É –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª—ñ.",
                symbolName: "globe.americas.fill",
                highlights: [
                    "–ù–∞—Ç–∞–ª—å–Ω–∞ –∫–∞—Ä—Ç–∞ ‚Äî —Ü–µ –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –∫–æ—Å–º—ñ—á–Ω–∏–π –ø–∞—Å–ø–æ—Ä—Ç",
                    "–†–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–∞—Ç–∏, —á–∞—Å—É —Ç–∞ –º—ñ—Å—Ü—è –≤–∞—à–æ–≥–æ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è",
                    "–ö–æ–∂–Ω–∞ –¥–µ—Ç–∞–ª—å –∫–∞—Ä—Ç–∏ —Ä–æ–∑–ø–æ–≤—ñ–¥–∞—î —É–Ω—ñ–∫–∞–ª—å–Ω—É —ñ—Å—Ç–æ—Ä—ñ—é –ø—Ä–æ –≤–∞—Å"
                ]
            ),

            // Page 2: What is Natal Chart
            OnboardingPage(
                title: "–ù–∞—Ç–∞–ª—å–Ω–∞ –∫–∞—Ä—Ç–∞ ‚Äî —Ü–µ –ø—Ä–æ –≤–∞—Å",
                message: "–°—Ö–µ–º–∞ –ø–æ–∑–∏—Ü—ñ–π –ø–ª–∞–Ω–µ—Ç —É –º–æ–º–µ–Ω—Ç –≤–∞—à–æ–≥–æ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è. –í–æ–Ω–∞ –ø–æ–∫–∞–∑—É—î –≤–∞—à—ñ —Å–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏, –≤–∏–∫–ª–∏–∫–∏ —Ç–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ.",
                symbolName: "circle.hexagongrid.fill",
                highlights: [
                    "12 –∑–Ω–∞–∫—ñ–≤ –∑–æ–¥—ñ–∞–∫—É —Ñ–æ—Ä–º—É—é—Ç—å –≤–∞—à—É –æ—Å–æ–±–∏—Å—Ç—ñ—Å—Ç—å",
                    "10 –ø–ª–∞–Ω–µ—Ç –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ —Ä—ñ–∑–Ω—ñ —Å—Ñ–µ—Ä–∏ –∂–∏—Ç—Ç—è",
                    "–ê—Å–ø–µ–∫—Ç–∏ –º—ñ–∂ –ø–ª–∞–Ω–µ—Ç–∞–º–∏ —Ä–æ–∑–∫—Ä–∏–≤–∞—é—Ç—å –≤–∑–∞—î–º–æ–¥—ñ—ó –µ–Ω–µ—Ä–≥—ñ–π"
                ]
            ),

            // Page 3: Three Steps
            OnboardingPage(
                title: "–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î –∑–∞ 3 –∫—Ä–æ–∫–∏",
                message: "–ü—Ä–æ—Å—Ç–∏–π –ø—Ä–æ—Ü–µ—Å, —è–∫–∏–π –∑–∞–π–º–µ –≤—Å—å–æ–≥–æ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω —Ç–∞ —Ä–æ–∑–∫—Ä–∏—î –≥–ª–∏–±–æ–∫—ñ —ñ–Ω—Å–∞–π—Ç–∏ –ø—Ä–æ –≤–∞—à–µ –º–∞–π–±—É—Ç–Ω—î.",
                symbolName: "1.circle.fill",
                highlights: [
                    "–ö—Ä–æ–∫ 1: –í–≤–µ–¥—ñ—Ç—å –¥–∞—Ç—É, —á–∞—Å —Ç–∞ –º—ñ—Å—Ü–µ –≤–∞—à–æ–≥–æ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è",
                    "–ö—Ä–æ–∫ 2: –í–∏–±–µ—Ä—ñ—Ç—å —Å—Ñ–µ—Ä—É –∂–∏—Ç—Ç—è –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É (—Ñ—ñ–Ω–∞–Ω—Å–∏, –∫–∞—Ä'—î—Ä–∞, —Å—Ç–æ—Å—É–Ω–∫–∏...)",
                    "–ö—Ä–æ–∫ 3: –û—Ç—Ä–∏–º–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç –≤—ñ–¥ AI —Ç–∞ –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ–≤"
                ]
            ),

            // Page 4: Life Areas
            OnboardingPage(
                title: "–î–æ—Å–ª—ñ–¥—ñ—Ç—å 5 –≤–∞–∂–ª–∏–≤–∏—Ö —Å—Ñ–µ—Ä",
                message: "–ö–æ–∂–Ω–∞ —Å—Ñ–µ—Ä–∞ –º—ñ—Å—Ç–∏—Ç—å –≥–ª–∏–±–æ–∫–∏–π –∞–Ω–∞–ª—ñ–∑ –∑ –ø—Ä–∞–∫—Ç–∏—á–Ω–∏–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è–º–∏ –¥–ª—è –≤–∞—à–æ–≥–æ —Ä–æ–∑–≤–∏—Ç–∫—É.",
                symbolName: "star.square.on.square.fill",
                highlights: [
                    "üí∞ –§—ñ–Ω–∞–Ω—Å–∏: –º–∞—Ç–µ—Ä—ñ–∞–ª—å–Ω–∞ –±–µ–∑–ø–µ–∫–∞ —Ç–∞ prosperity",
                    "üíº –ö–∞—Ä'—î—Ä–∞: –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª —Ç–∞ —É—Å–ø—ñ—Ö",
                    "‚ù§Ô∏è –°—Ç–æ—Å—É–Ω–∫–∏: –ª—é–±–æ–≤, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Ç–∞ –±–ª–∏–∑—å–∫—ñ—Å—Ç—å"
                ]
            ),

            // Page 5: AI + Experts
            OnboardingPage(
                title: "–ï–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ + –®—Ç—É—á–Ω–∏–π —ñ–Ω—Ç–µ–ª–µ–∫—Ç",
                message: "–ú–∏ –∫–æ–º–±—ñ–Ω—É—î–º–æ –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ –≤—ñ–¥ —Ñ–∞—Ö—ñ–≤—Ü—ñ–≤ –∑ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—é —Å—É—á–∞—Å–Ω–æ–≥–æ AI –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ—á–Ω–∏—Ö –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤.",
                symbolName: "brain.fill",
                highlights: [
                    "–ö—É—Ä–∞—Ç–æ—Ä—Å—å–∫–∏–π –Ω–∞–±—ñ—Ä –ø—Ä–∞–≤–∏–ª –≤—ñ–¥ –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏—Ö –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ–≤",
                    "AI –∞–Ω–∞–ª—ñ–∑—É—î –≤–∞—à—É –∫–∞—Ä—Ç—É –∑ —Ç–æ—á–Ω—ñ—Å—Ç—é —Å—É—á–∞—Å–Ω–∏—Ö –∞–ª–≥–æ—Ä–∏—Ç–º—ñ–≤",
                    "–†–µ–∑—É–ª—å—Ç–∞—Ç: –ø—Ä–∞–∫—Ç–∏—á–Ω—ñ, —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó"
                ]
            ),

            // Page 6: Pricing Model
            OnboardingPage(
                title: "–û–ø–ª–∞—á—É–π—Ç–µ –ª–∏—à–µ —Ç–µ, —â–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ",
                message: "–ñ–æ–¥–Ω–∏—Ö –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏—Ö –ø–ª–∞—Ç–µ–∂—ñ–≤, –∂–æ–¥–Ω–∏—Ö –ø—ñ–¥–ø–∏—Å–æ–∫. –ö—É–ø—É–π—Ç–µ –∑–≤—ñ—Ç–∏ –æ–∫—Ä–µ–º–æ –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –≤–∞—à–∏—Ö —ñ–Ω—Ç–µ—Ä–µ—Å—ñ–≤.",
                symbolName: "creditcard.fill",
                highlights: [
                    "–ö–æ–∂–Ω–∞ —Å—Ñ–µ—Ä–∞ –∫—É–ø—É—î—Ç—å—Å—è –æ–∫—Ä–µ–º–æ ‚Äî –ø–æ–≤–Ω–∞ –≥–Ω—É—á–∫—ñ—Å—Ç—å",
                    "–û–¥–∏–Ω —Ä–∞–∑ –∫—É–ø–ª–µ–Ω–∏–π –∑–≤—ñ—Ç ‚Äî –≤—ñ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø",
                    "–ü—Ä–æ–∑–æ—Ä–µ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–µ–∑ —Å—é—Ä–ø—Ä–∏–∑—ñ–≤"
                ]
            ),

            // Page 7: Ready to Start
            OnboardingPage(
                title: "–ì–æ—Ç–æ–≤—ñ –≤—ñ–¥–∫—Ä–∏—Ç–∏ —Å–µ–±–µ?",
                message: "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å '–†–æ–∑–ø–æ—á–∞—Ç–∏' ‚Äî —ñ –º–∏ –ø—Ä–æ–≤–µ–¥–µ–º–æ –≤–∞—Å —á–µ—Ä–µ–∑ –≤–≤–µ–¥–µ–Ω–Ω—è –≤–∞—à–æ—ó –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏ —Ç–∞ –ø–µ—Ä—à–∏—Ö –≤–∏—Å–Ω–æ–≤–∫—ñ–≤.",
                symbolName: "rocket.fill",
                highlights: [
                    "–í–∞—à—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó",
                    "–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ—á–Ω—ñ—Ç—å",
                    "–ù–∞—Ç–∞–ª—å–Ω–∞ –∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞ –∑–∞ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω"
                ]
            ),
        ]
    }

    static func resetStoredProgress(storage: UserDefaults = .standard) {
        storage.removeObject(forKey: completionKey)
    }
}
